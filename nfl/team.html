<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OBS Embed View - NFL Live Tracker</title>
  <link rel="icon" href="football.png" type="image/png" />
  <link rel="stylesheet" href="style.css"/>
  <style>
    body {
      margin: 0;
      background: transparent;
      padding-top: 25px;
      padding-left: 50px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
    }

    #scaleWrapper {
      transform: scale(2);
      transform-origin: top left;
    }
  
    .game-card {
      margin: 0 auto;
      max-width: 400px;
    }
  </style>
</head>
<body>
<div id="scaleWrapper">
  <div id="gameBlockContainer"></div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const teamAbbreviation = params.get("team");
    let currentHtml = "";

    // Custom styles functionality
    function loadSavedStyles() {
      // URL parameters always take priority over localStorage
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('bgColor') || urlParams.has('bgOpacity') || urlParams.has('textColor')) {
        const bgOpacityParam = urlParams.get('bgOpacity');
        return {
          backgroundColor: urlParams.get('bgColor') || '#1a1a1a',
          backgroundOpacity: bgOpacityParam !== null ? parseInt(bgOpacityParam) : 100,
          textColor: urlParams.get('textColor') || '#ffffff'
        };
      }
      
      // Only use localStorage if no URL parameters are present
      const saved = localStorage.getItem('nfl-game-card-styles');
      return saved ? JSON.parse(saved) : {
        backgroundColor: '#1a1a1a',
        backgroundOpacity: 100,
        textColor: '#ffffff'
      };
    }

    function hexToRgba(hex, opacity) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }

    function applyCustomStylesToCard(card) {
      const customStyles = loadSavedStyles();
      const opacity = customStyles.backgroundOpacity / 100;
      const bgColor = hexToRgba(customStyles.backgroundColor, opacity);
      
      // Remove any existing inline background-color first
      card.style.removeProperty('background-color');
      // Then set the new background color with important flag
      card.style.setProperty('background-color', bgColor, 'important');
      card.style.setProperty('color', customStyles.textColor, 'important');
      
      // Apply text color to all text elements within the card
      const textElements = card.querySelectorAll('.card-team-name, .card-team-record, .game-status, .game-time, .game-headline, .game-info, .period-info, .team-score, .no-game-text');
      textElements.forEach(element => {
        element.style.setProperty('color', customStyles.textColor, 'important');
      });
    }

    async function fetchAndRenderTeamGame(teamAbbreviation) {
      const adjustedDate = getAdjustedDateForNFL();
      const SCOREBOARD_API_URL = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${adjustedDate}`;

      try {
        const res = await fetch(SCOREBOARD_API_URL);
        const data = await res.json();
        const games = data.events || [];

        const container = document.getElementById("gameBlockContainer");
        const game = games.find(g =>
          g.competitions[0].competitors.some(c => c.team.abbreviation === teamAbbreviation)
        );

        if (!game) {
          const TEAMS_API_URL = "https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams";
          const teamsRes = await fetch(TEAMS_API_URL);
          const teamsData = await teamsRes.json();
          const team = teamsData.sports[0].leagues[0].teams
            .map(teamData => teamData.team)
            .find(t => t.abbreviation === teamAbbreviation);
          const logoUrl = team.logos?.find(logo =>
        logo.rel.includes(
          ["19", "20"].includes(team.id) ? 'dark' : 'default'
        )
      )?.href || `https://a.espncdn.com/i/teamlogos/nfl/500/${team.abbreviation}.png`;

          const noGameCard = document.createElement("div");
          noGameCard.className = "game-card no-game-card";
          noGameCard.style.display = "flex";
          noGameCard.style.flexDirection = "column";
          noGameCard.style.alignItems = "center";
          noGameCard.style.justifyContent = "center";
          noGameCard.style.gap = "10px";
          noGameCard.style.padding = "20px";
          noGameCard.style.width = "300px";

          noGameCard.innerHTML = `
            <img src="${logoUrl}" alt="${team?.displayName || "Unknown"} logo" class="card-team-logo team-shadow">
            <div class="no-game-text">No game scheduled <br> for today</div>
          `;

          applyCustomStylesToCard(noGameCard);
          const newHtml = noGameCard.innerHTML;
          if (newHtml !== currentHtml) {
            container.innerHTML = "";
            container.appendChild(noGameCard);
            currentHtml = newHtml;
          }
          return;
        }

        if (typeof buildGameCard === "function") {
          const cardHtml = await buildGameCard(game, game.competitions[0].competitors[0]?.team || {});
          const newHtml = cardHtml;
          if (newHtml !== currentHtml) {
            container.innerHTML = "";
            container.innerHTML = cardHtml;
            currentHtml = newHtml;
            // Apply custom styles to the newly created cards
            const gameCards = container.querySelectorAll('.game-card');
            gameCards.forEach(card => applyCustomStylesToCard(card));
          }
        }
      } catch (err) {
        console.error("Error loading team game block:", err);
      }
    }

    const script = document.createElement("script");
    script.src = "teams.js";
    document.body.appendChild(script);

    script.onload = () => {
      if (teamAbbreviation) {
        // Show the game card immediately on load
        fetchAndRenderTeamGame(teamAbbreviation);

        setInterval(async () => {
          await fetchAndRenderTeamGame(teamAbbreviation);
        }, 2000);
      }
    };
  </script>
</div>
</body>
</html>
